// Generated by CoffeeScript 1.6.3
(function() {
  var Canvas, Css3Support, DiagonalSlider, _ANGLE_TEXT, _PERCENT_DISTRIBUTION_CLIP, _PERCENT_DISTRIBUTION_CONT;

  _ANGLE_TEXT = -55;

  _PERCENT_DISTRIBUTION_CLIP = 0.25;

  _PERCENT_DISTRIBUTION_CONT = 1 - _PERCENT_DISTRIBUTION_CLIP * 2;

  Css3Support = (function() {
    Css3Support.prototype.vendors = ['-webkit-', '-o-', '-ms-', '-moz-', ''];

    /* Css3 quick support check*/


    function Css3Support() {
      var p;
      p = document.createElement('p');
      this.testElement = p;
      document.body.insertBefore(this.testElement, null);
    }

    Css3Support.prototype.supports = function(key) {
      var e, v, _i, _len, _ref;
      _ref = this.vendors;
      for (e = _i = 0, _len = _ref.length; _i < _len; e = ++_i) {
        v = _ref[e];
        if (window.getComputedStyle(this.testElement).getPropertyValue(v + key)) {
          return {
            vendor: v,
            property: v + key
          };
        }
      }
      return false;
    };

    return Css3Support;

  })();

  Canvas = (function() {
    function Canvas(w, h) {
      this.canvas = document.createElement('canvas');
      this.canvas.width = w;
      this.canvas.height = h;
      this.context = this.canvas.getContext('2d');
    }

    Canvas.prototype.w = function() {
      return this.canvas.width;
    };

    Canvas.prototype.h = function() {
      return this.canvas.height;
    };

    Canvas.prototype.getContext = function() {
      return this.context;
    };

    Canvas.prototype.getImage = function() {
      return this.canvas.toDataURL();
    };

    Canvas.prototype.imageToDataUrl = function(image) {
      var n;
      n = new Canvas(image.width, image.height);
      return n.getImage();
    };

    Canvas.prototype.drawTitle = function(text, x, y) {
      var metric, tx, ty;
      if (x == null) {
        x = 0;
      }
      if (y == null) {
        y = 0;
      }
      console.log('drawTitle', text, x, y);
      metric = this.context.measureText(text);
      this.context.save();
      if (true) {
        tx = x - (metric.width / 2);
        ty = y;
        this.context.translate(tx, ty);
        this.context.rotate(_ANGLE_TEXT * Math.PI / 180);
        this.context.translate(-tx, -ty);
      }
      this.context.fillText(text, x, y);
      this.context.restore();
      return this;
    };

    Canvas.prototype.clipImageInDiagonal = function(imageElement, mode, bothSides) {
      var p0, p1, wside;
      if (mode == null) {
        mode = 45;
      }
      if (bothSides == null) {
        bothSides = false;
      }
      p0 = {
        x: 0,
        y: this.h()
      };
      p1 = {
        x: this.w(),
        y: 0
      };
      this.context.save();
      this.context.beginPath();
      if (mode === 'trapecy') {
        wside = _PERCENT_DISTRIBUTION_CLIP * this.w();
        this.context.moveTo(0, 0);
        this.context.lineTo(wside, 0);
        this.context.lineTo(this.w(), 0);
        this.context.lineTo(this.w() - wside, this.h());
        this.context.lineTo(0, this.h());
        this.context.lineTo(wside, 0);
      }
      if (mode === 45) {
        this.context.moveTo(p0.x, p0.y);
        this.context.lineTo(p1.x, p1.y);
        this.context.lineTo(0, 0);
      }
      this.context.closePath();
      this.context.save();
      this.context.clip();
      this.context.drawImage(imageElement, 0, 0);
      this.context.restore();
      return this;
    };

    return Canvas;

  })();

  DiagonalSlider = (function() {
    DiagonalSlider.prototype.canvas = null;

    DiagonalSlider.prototype.defaults = {
      width: 960,
      height: 300,
      angleClip: 35,
      opening: 120
    };

    DiagonalSlider.prototype.backToOrigen = function(callback) {
      this.slides.each(function(i) {
        var slide;
        slide = $(this);
        return slide.stop(false, false).animate({
          left: slide.data('origen_x')
        });
      });
      if (callback) {
        callback.apply(this, null);
      }
      return this;
    };

    DiagonalSlider.prototype.handleClickEvent = function(event, index, ref) {
      var init_x, opening, prev, slice;
      if (this.scope.data('currentIndex') === index) {
        this.scope.data('currentIndex', 0);
        this.backToOrigen(null);
        return false;
      }
      opening = this.defaults.opening;
      prev = this.slides.eq(index);
      slice = this.slides.filter(':gt(' + (--index) + ')');
      init_x = parseInt(prev.css('left')) + prev.width() * _PERCENT_DISTRIBUTION_CLIP;
      this.backToOrigen(function() {
        slice.each(function(i) {
          return $(this).animate({
            left: init_x + (i * opening)
          });
        });
        return this.scope.data('currentIndex', index);
      });
      return true;
    };

    function DiagonalSlider(scope, options) {
      var holder, opening, self, sliderHeight, sliderWidth, slides, slidesCount, wtotal;
      this.scope = scope;
      self = this;
      sliderWidth = this.defaults.width;
      sliderHeight = this.defaults.height;
      opening = this.defaults.opening;
      this.scope.css('width', sliderWidth);
      this.scope.css('height', sliderHeight);
      this.scope.data('currentIndex', 0);
      holder = $('ul,ol', this.scope).addClass('clearfix');
      this.slides = slides = holder.find('li').css('width', sliderWidth);
      slidesCount = slides.size();
      wtotal = 0;
      slides.each(function(index, el) {
        var alt, css3, dataUrl, dcanvas, dl, dw, hasSettedLeftProp, i, image, imagej, items, me, origen_x, tleft, tproperty, transform, transformDegs, tstyle, _i, _len, _ref;
        me = $(this);
        dw = me.width();
        imagej = me.find('img');
        image = imagej.get(0);
        dcanvas = new Canvas(image.width, image.height);
        me.css('z-index', index + 1 + 100);
        css3 = new Css3Support();
        transform = css3.supports('transform');
        if (transform) {
          transformDegs = 'rotate(' + self.defaults.angleClip + 'deg)';
          tstyle = transform.vendor + 'transform-style';
          tproperty = transform.property;
          dl = $('<div></div>');
          dl.css(tproperty, transformDegs);
          dl.css(tstyle, 'preserve-3d');
          dl.css({
            height: sliderHeight * 1.5,
            width: opening * 0.7,
            left: _PERCENT_DISTRIBUTION_CLIP * 100,
            position: 'absolute',
            zIndex: index + 3 + 100,
            top: -50,
            cursor: 'pointer'
          });
          dl.bind('mouseover', function(event) {
            return me.toggleClass('d-hover');
          });
          dl.click(function(event) {
            event.preventDefault();
            event.stopPropagation();
            slides.removeClass('d-active');
            me.toggleClass('d-active');
            return self.handleClickEvent.apply(self, [event, index, me]);
          });
          me.append(dl);
        } else {
          items = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20];
          _ref = items.length;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            i = _ref[_i];
            dl = $('<div></div>');
            dl.css({
              width: opening,
              height: items.length / sliderHeight
            });
            me.append(dl);
          }
        }
        if (index === 0) {
          origen_x = -(dw * _PERCENT_DISTRIBUTION_CLIP);
          me.addClass('first').data('origen_x', origen_x).css('left', origen_x + 'px');
          hasSettedLeftProp = true;
        }
        if (index === slidesCount - 1) {
          me.addClass('last');
        }
        wtotal += dw;
        dcanvas.clipImageInDiagonal(image, 'trapecy', index > 1);
        if ((alt = imagej.attr('alt')) !== null) {
          dcanvas.drawTitle(alt, dw * _PERCENT_DISTRIBUTION_CLIP, sliderHeight / 2);
        }
        dataUrl = dcanvas.getImage();
        if (!hasSettedLeftProp) {
          tleft = index * opening;
          me.data('origen_x', tleft).css('left', tleft + 'px');
        }
        me.css('cursor', 'pointer').click(function(event) {
          slides.removeClass('d-active');
          me.toggleClass('d-active');
          return self.handleClickEvent.apply(self, [event, index, me]);
        });
        return image.src = dataUrl;
      });
      holder.css({
        width: wtotal + 'px'
      });
    }

    return DiagonalSlider;

  })();

  if (typeof this.$(!void 0)) {
    $.fn.diagonalSlider = function(options) {
      var isMethodCall, selection;
      selection = $(this);
      isMethodCall = typeof options === "string";
      selection.each(function() {
        var instance, me;
        me = $(this).addClass('dslider');
        instance = new DiagonalSlider(me);
        me.data('diagonalSlider', instance);
        return me;
      });
      return selection;
    };
  }

}).call(this);
